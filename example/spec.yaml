tech_stack:
  language: python 3.12
  framework: fastapi
  database: postgresql + sqlalchemy 2.0 + asyncpg
  task_queue: redis + arq
  validation: pydantic 2
  testing: pytest + pytest-asyncio + httpx
  frontend: react 18 + typescript + shadcn/ui + tailwind
deployment:
  model: monolith
  target: docker
  scaling: horizontal (stateless design)
conventions:
  type_case: PascalCase
  function_case: snake_case
  module_case: snake_case
  constant_case: UPPER_SNAKE_CASE
  error_handling: exceptions (custom hierarchy)
  visibility: _prefix for private
  file_naming: snake_case.py
structure:
  root: src
  layout: by_feature
  pattern: folder
  layers:
    core: src/hiagent_core
    dashboard: src/hiagent_dashboard
    app: app
  components:
    sdk: src/hiagent_core/sdk
    database: src/hiagent_core/database
    auth: src/hiagent_core/auth
    events: src/hiagent_core/events
    workers: src/hiagent_core/workers
    observability: src/hiagent_core/observability
    config: src/hiagent_core/config
    api: src/hiagent_core/api
    agent_configs: src/hiagent_dashboard/agent_configs
    users: src/hiagent_dashboard/users
    analytics: src/hiagent_dashboard/analytics
    agent_testing: src/hiagent_dashboard/agent_testing
    example: app/modules/example
  types:
    core: src/hiagent_core/types.py
    dashboard: src/hiagent_dashboard/types.py
    app: app/types.py
  shared: src/hiagent_core
  tests: tests
  configs: .
  entrypoints:
    main: app/main.py
    worker: app/worker.py
components:
  sdk:
    for: HiAgent SDK wrapper with ChatService singleton and Agent/Workflow/Retriever
      facades
    layer: infrastructure
    provides:
    - invoke_agent:
        for: Invoke HiAgent agent with query
        input: InvokeAgentInput
        output: InvokeAgentResult | AgentInvocationFailed | AgentTimeout
    - stream_agent:
        for: Stream HiAgent agent response
        input: InvokeAgentInput
        output: StreamChunk | AgentInvocationFailed | AgentTimeout
    - get_chat_service:
        for: Get singleton ChatService instance
        input: None
        output: ChatService
    emits:
    - AgentInvoked:
        for: Agent invocation started
        payload: InvokeAgentInput
    - AgentCompleted:
        for: Agent invocation finished
        payload: InvokeAgentResult
    - AgentFailed:
        for: Agent invocation failed
        payload: AgentInvocationFailed
    subscribes: []
    consumes:
    - config
    owns_data: []
  database:
    for: Async SQLAlchemy engine, session factory, and Base model
    layer: infrastructure
    provides:
    - get_session:
        for: Get async database session for request
        input: None
        output: SessionContext
    - health_check:
        for: Check database connectivity
        input: None
        output: bool | DatabaseConnectionFailed
    emits: []
    subscribes: []
    consumes:
    - config
    owns_data:
    - SessionContext
  auth:
    for: JWT encoding/decoding, password hashing, and auth dependencies
    layer: infrastructure
    provides:
    - login:
        for: Authenticate user and issue tokens
        input: LoginInput
        output: TokenPair | InvalidCredentials
    - verify_token:
        for: Validate JWT and extract user
        input: str
        output: CurrentUser | TokenExpired | TokenInvalid
    - require_role:
        for: Dependency that checks user role
        input: Role
        output: CurrentUser | PermissionDenied
    - hash_password:
        for: Hash password for storage
        input: str
        output: str
    - verify_password:
        for: Verify password against hash
        input: (str, str)
        output: bool
    emits:
    - UserLoggedIn:
        for: User authenticated successfully
        payload: CurrentUser
    subscribes: []
    consumes:
    - config
    - database
    owns_data:
    - TokenPair
    - CurrentUser
  events:
    for: In-process event bus for pub/sub communication between components
    layer: infrastructure
    provides:
    - publish:
        for: Emit event to bus
        input: EventPayload
        output: None
    - subscribe:
        for: Register handler for event type
        input: str
        output: None
    emits: []
    subscribes: []
    consumes:
    - observability
    owns_data:
    - Event
    - EventPayload
  workers:
    for: ARQ-based async task queue for background agent processing
    layer: infrastructure
    provides:
    - enqueue:
        for: Submit task to queue
        input: TaskPayload
        output: str | TaskQueueFailed
    - get_result:
        for: Get task result by ID
        input: str
        output: TaskResult
    emits:
    - TaskQueued:
        for: Background task submitted
        payload: TaskPayload
    - TaskCompleted:
        for: Background task finished
        payload: TaskResult
    - TaskFailed:
        for: Background task failed
        payload: TaskPayload
    subscribes: []
    consumes:
    - config
    - events
    owns_data:
    - TaskPayload
    - TaskResult
  observability:
    for: Structured JSON logging, Prometheus metrics, and request tracing
    layer: infrastructure
    provides:
    - get_logger:
        for: Get structured logger with context
        input: str
        output: Logger
    - record_metric:
        for: Record a metric value
        input: str
        output: None
    - get_correlation_id:
        for: Get current request correlation ID
        input: None
        output: str
    emits: []
    subscribes:
    - '*': Log and record metrics for all events
    consumes:
    - config
    owns_data: []
  config:
    for: Pydantic settings with environment variable loading and validation
    layer: infrastructure
    provides:
    - get_settings:
        for: Get validated settings instance
        input: None
        output: Settings
    emits: []
    subscribes: []
    consumes: []
    owns_data: []
  api:
    for: FastAPI app factory, exception handlers, and common middleware
    layer: infrastructure
    provides:
    - create_app:
        for: Create configured FastAPI application
        input: None
        output: FastAPI
    - include_router:
        for: Register router on application
        input: Router
        output: None
    emits: []
    subscribes: []
    consumes:
    - config
    - observability
    - auth
    owns_data: []
  agent_configs:
    for: Managing AgentConfig CRUD, storing HiAgent app_keys for easy integration
    layer: domain
    provides:
    - create_config:
        for: Create new agent configuration
        input: CreateAgentConfigInput
        output: AgentConfig | DuplicateAgentConfig | InvalidAgentConfig
    - get_config:
        for: Get agent config by ID
        input: str
        output: AgentConfig | AgentConfigNotFound
    - list_configs:
        for: List all agent configurations
        input: None
        output: list[AgentConfigSummary]
    - update_config:
        for: Update agent configuration
        input: UpdateAgentConfigInput
        output: AgentConfig | AgentConfigNotFound | DuplicateAgentConfig
    - delete_config:
        for: Delete agent configuration
        input: str
        output: None | AgentConfigNotFound
    emits:
    - AgentConfigCreated:
        for: New agent config added
        payload: AgentConfig
    - AgentConfigUpdated:
        for: Agent config modified
        payload: AgentConfig
    - AgentConfigDeleted:
        for: Agent config removed
        payload: str
    subscribes: []
    consumes:
    - database
    - events
    owns_data:
    - AgentConfig
  users:
    for: Dashboard user management, authentication, and role-based access control
    layer: domain
    provides:
    - create_user:
        for: Create new dashboard user
        input: CreateUserInput
        output: User | DuplicateUser
    - get_user:
        for: Get user by ID
        input: str
        output: User | UserNotFound
    - list_users:
        for: List all users
        input: None
        output: list[UserSummary]
    - update_user:
        for: Update user profile or role
        input: UpdateUserInput
        output: User | UserNotFound
    - delete_user:
        for: Deactivate user account
        input: str
        output: None | UserNotFound
    emits:
    - UserCreated:
        for: New user added
        payload: User
    subscribes: []
    consumes:
    - database
    - auth
    - events
    owns_data:
    - User
    - Role
  analytics:
    for: RequestLog storage, usage metrics, and real-time analytics
    layer: domain
    provides:
    - log_request:
        for: Record API request for analytics
        input: RequestLog
        output: None
    - query_usage:
        for: Get usage metrics for time range
        input: AnalyticsQuery
        output: UsageMetrics
    - query_agent_metrics:
        for: Get per-agent performance metrics
        input: AnalyticsQuery
        output: list[AgentMetrics]
    emits: []
    subscribes:
    - AgentInvoked: Create request log entry
    - AgentCompleted: Update request log with result
    - AgentFailed: Update request log with error
    consumes:
    - database
    - events
    owns_data:
    - RequestLog
    - UsageMetrics
    - AgentMetrics
  agent_testing:
    for: AgentTestRun execution and history for testing agents before production
    layer: domain
    provides:
    - run_test:
        for: Execute agent test
        input: RunTestInput
        output: TestResult | AgentConfigNotFound | AgentInvocationFailed
    - get_test_history:
        for: Get test runs for agent config
        input: str
        output: list[AgentTestRun]
    emits:
    - TestRunCompleted:
        for: Agent test finished
        payload: TestResult
    subscribes: []
    consumes:
    - database
    - sdk
    - agent_configs
    - events
    owns_data:
    - AgentTestRun
    - TestResult
  example:
    for: Example business module demonstrating extension patterns
    layer: application
    provides:
    - example_handler:
        for: Demonstrate business logic pattern
        input: dict
        output: dict
    emits: []
    subscribes: []
    consumes:
    - sdk
    - database
    - events
    owns_data: []
architecture:
  global_patterns:
    dependency_injection:
      approach: constructor
      for: FastAPI Depends() provides Pythonic DI, testable, no container needed
    error_handling:
      approach: exceptions
      for: Custom exception hierarchy with centralized FastAPI handlers
    async:
      approach: async_await
      for: SDK uses async, FastAPI async-native, PostgreSQL via asyncpg
  component_patterns:
    sdk:
      pattern: singleton + factory
      for: ChatService singleton initialized once; Agents created per-request via
        factory
    database:
      pattern: repository
      for: Abstracts data access, testable, swappable
    events:
      pattern: observer
      for: Loose coupling between components via pub/sub
    workers:
      pattern: command
      for: Task payloads as serializable commands for queue
    auth:
      pattern: strategy
      for: Multiple auth methods possible (JWT, API key)
    config:
      pattern: hierarchy
      for: Core settings + app settings extension via inheritance
integrations:
- name: hiagent
  for: Agent execution via HiAgent SDK
  direction: outbound
  consumed_by:
  - sdk
- name: postgresql
  for: Data persistence
  direction: bidirectional
  consumed_by:
  - database
- name: redis
  for: Task queue and background processing
  direction: bidirectional
  consumed_by:
  - workers
- name: prometheus
  for: Metrics collection (scrape model)
  direction: outbound
  consumed_by:
  - observability
boundaries:
  error_handling: Custom exception hierarchy; all errors logged with correlation ID;
    API returns structured error responses
  security: JWT authentication for dashboard; secrets via environment variables; input
    validation via Pydantic
  events: In-process event bus; events have type + payload + correlation_id; handlers
    registered at startup
types:
  AgentConfig:
    for: HiAgent agent configuration storing app_key, name, variables for easy integration
    category: domain
    used:
    - agent_configs.create_config
    - agent_configs.emits.AgentConfigCreated
    - agent_configs.emits.AgentConfigUpdated
    - agent_configs.get_config
    - agent_configs.owns_data
    - agent_configs.update_config
  RequestLog:
    for: API request audit trail with correlation ID, tokens, duration
    category: domain
    used:
    - analytics.log_request
    - analytics.owns_data
  Event:
    for: Internal event bus message with type, payload, status
    category: domain
    used:
    - events.owns_data
  User:
    for: Dashboard user with credentials and role for authentication
    category: domain
    used:
    - users.create_user
    - users.emits.UserCreated
    - users.get_user
    - users.owns_data
    - users.update_user
  AgentTestRun:
    for: Agent test execution record with input, output, status
    category: domain
    used:
    - agent_testing.get_test_history
    - agent_testing.owns_data
  Conversation:
    for: HiAgent conversation reference (conversation_id returned by SDK)
    category: domain
    used: []
  Role:
    for: User role enum (Admin, Configurator, Viewer)
    category: domain
    used:
    - auth.require_role
    - users.owns_data
  InvokeAgentInput:
    for: Query, agent_config_id, user_id, conversation_id for agent invocation
    category: input
    used:
    - sdk.emits.AgentInvoked
    - sdk.invoke_agent
    - sdk.stream_agent
  LoginInput:
    for: Username and password for authentication
    category: input
    used:
    - auth.login
  CreateAgentConfigInput:
    for: Data to create new agent configuration
    category: input
    used:
    - agent_configs.create_config
  UpdateAgentConfigInput:
    for: Data to update existing agent configuration
    category: input
    used:
    - agent_configs.update_config
  CreateUserInput:
    for: Data to create new dashboard user
    category: input
    used:
    - users.create_user
  UpdateUserInput:
    for: Data to update user profile or role
    category: input
    used:
    - users.update_user
  AnalyticsQuery:
    for: Time range, filters for analytics queries
    category: input
    used:
    - analytics.query_agent_metrics
    - analytics.query_usage
  RunTestInput:
    for: Agent config ID and test input to execute
    category: input
    used:
    - agent_testing.run_test
  TaskPayload:
    for: Serialized task data for queue
    category: input
    used:
    - workers.emits.TaskFailed
    - workers.emits.TaskQueued
    - workers.enqueue
    - workers.owns_data
  EventPayload:
    for: Generic event data container
    category: input
    used:
    - events.owns_data
    - events.publish
  InvokeAgentResult:
    for: Response text, conversation_id, tokens used from agent invocation
    category: output
    used:
    - sdk.emits.AgentCompleted
    - sdk.invoke_agent
  StreamChunk:
    for: Streaming event chunk from agent
    category: output
    used:
    - sdk.stream_agent
  SessionContext:
    for: Async database session for request scope
    category: output
    used:
    - database.get_session
    - database.owns_data
  TokenPair:
    for: Access token and refresh token
    category: output
    used:
    - auth.login
    - auth.owns_data
  CurrentUser:
    for: Authenticated user context for dependencies
    category: output
    used:
    - auth.emits.UserLoggedIn
    - auth.owns_data
    - auth.require_role
    - auth.verify_token
  AgentConfigSummary:
    for: Agent config list item for browsing
    category: output
    used:
    - agent_configs.list_configs
  UserSummary:
    for: User list item without sensitive data
    category: output
    used:
    - users.list_users
  UsageMetrics:
    for: Aggregated usage statistics
    category: output
    used:
    - analytics.owns_data
    - analytics.query_usage
  AgentMetrics:
    for: Per-agent performance metrics
    category: output
    used:
    - analytics.owns_data
    - analytics.query_agent_metrics
  TestResult:
    for: Test execution result with timing
    category: output
    used:
    - agent_testing.emits.TestRunCompleted
    - agent_testing.owns_data
    - agent_testing.run_test
  TaskResult:
    for: Task execution result with status
    category: output
    used:
    - workers.emits.TaskCompleted
    - workers.get_result
    - workers.owns_data
  AgentConfigNotFound:
    for: Requested agent config ID doesn't exist
    category: error
    used:
    - agent_configs.delete_config
    - agent_configs.get_config
    - agent_configs.update_config
    - agent_testing.run_test
  UserNotFound:
    for: Requested user doesn't exist
    category: error
    used:
    - users.delete_user
    - users.get_user
    - users.update_user
  InvalidCredentials:
    for: Login credentials don't match
    category: error
    used:
    - auth.login
  TokenExpired:
    for: JWT token has expired
    category: error
    used:
    - auth.verify_token
  TokenInvalid:
    for: JWT token is malformed or tampered
    category: error
    used:
    - auth.verify_token
  PermissionDenied:
    for: User lacks required role for operation
    category: error
    used:
    - auth.require_role
  AgentInvocationFailed:
    for: HiAgent SDK call failed
    category: error
    used:
    - agent_testing.run_test
    - sdk.emits.AgentFailed
    - sdk.invoke_agent
    - sdk.stream_agent
  AgentTimeout:
    for: HiAgent call exceeded timeout
    category: error
    used:
    - sdk.invoke_agent
    - sdk.stream_agent
  DatabaseConnectionFailed:
    for: PostgreSQL connection failed
    category: error
    used:
    - database.health_check
  TaskQueueFailed:
    for: Redis/ARQ task submission failed
    category: error
    used:
    - workers.enqueue
  DuplicateAgentConfig:
    for: Agent config with same name already exists
    category: error
    used:
    - agent_configs.create_config
    - agent_configs.update_config
  DuplicateUser:
    for: User with same username already exists
    category: error
    used:
    - users.create_user
  InvalidAgentConfig:
    for: Agent config data doesn't meet requirements
    category: error
    used:
    - agent_configs.create_config
  AgentInvoked:
    for: Agent invocation started (for request logging)
    category: event
    used:
    - analytics.subscribes
    - sdk.emits.AgentInvoked
  AgentCompleted:
    for: Agent invocation finished with response (for analytics)
    category: event
    used:
    - analytics.subscribes
    - sdk.emits.AgentCompleted
  AgentFailed:
    for: Agent invocation failed with error (for alerting)
    category: event
    used:
    - analytics.subscribes
    - sdk.emits.AgentFailed
  AgentConfigCreated:
    for: New agent config added (for audit trail)
    category: event
    used:
    - agent_configs.emits.AgentConfigCreated
  AgentConfigUpdated:
    for: Agent config modified (for audit trail)
    category: event
    used:
    - agent_configs.emits.AgentConfigUpdated
  AgentConfigDeleted:
    for: Agent config removed (for audit trail)
    category: event
    used:
    - agent_configs.emits.AgentConfigDeleted
  UserLoggedIn:
    for: User authenticated successfully (for security audit)
    category: event
    used:
    - auth.emits.UserLoggedIn
  UserCreated:
    for: New user added (for audit trail)
    category: event
    used:
    - users.emits.UserCreated
  TestRunCompleted:
    for: Agent test finished (for analytics)
    category: event
    used:
    - agent_testing.emits.TestRunCompleted
  TaskQueued:
    for: Background task submitted to queue (for monitoring)
    category: event
    used:
    - workers.emits.TaskQueued
  TaskCompleted:
    for: Background task finished processing (for monitoring)
    category: event
    used:
    - workers.emits.TaskCompleted
  TaskFailed:
    for: Background task failed (for alerting)
    category: event
    used:
    - workers.emits.TaskFailed
